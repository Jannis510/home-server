name: home-server
services:
  unbound:
    image: mvance/unbound:1.19.3
    container_name: unbound
    networks:
      - dns_net
    volumes:
      - ./config/unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
      - unbound:/opt/unbound/etc/unbound/var
    restart: unless-stopped
    expose:
      - "5335"
    healthcheck:
      test: ["CMD-SHELL", "drill @127.0.0.1 -p 5335 example.com || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5


  pihole:
    image: pihole/pihole:2025.08.0
    container_name: pihole
    hostname: pihole
    depends_on:
      unbound:
        condition: service_healthy
    networks:
      - dns_net
      - proxy_net
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    environment:
      TZ: "${TZ}"
      FTLCONF_webserver_api_password: "${PIHOLE_WEBPASSWORD}"
      DNSMASQ_LISTENING: "${PIHOLE_DNSMASQ_LISTENING:-all}"
      # Pi-hole nutzt Unbound als Upstream (Containername im dns_net)
      FTLCONF_dns_upstreams: "${PIHOLE_DNS_UPSTREAMS:-unbound#5335}"
      RATE_LIMIT: "${PIHOLE_RATE_LIMIT:-0/0}"
      FTLCONF_dns_hosts: |-
        ${PIHOLE_LOCAL_IP:-192.168.0.10} pihole.home.arpa
        ${PIHOLE_LOCAL_IP:-192.168.0.10} traefik.home.arpa
    volumes:
      - pihole-etc:/etc/pihole
      - pihole-dnsmasq:/etc/dnsmasq.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pihole status >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy_net

      # Redirect von pihole.home.arpa -> /admin/
      - traefik.http.routers.pihole.rule=Host(`pihole.home.arpa`)
      - traefik.http.routers.pihole.entrypoints=websecure
      - traefik.http.routers.pihole.tls=true
      - traefik.http.routers.pihole.tls.certresolver=stepca
      - traefik.http.routers.pihole.service=pihole-svc
      - traefik.http.services.pihole-svc.loadbalancer.server.port=80

      - traefik.http.routers.pihole.middlewares=pihole-redirect
      - traefik.http.middlewares.pihole-redirect.redirectregex.regex=^https?://pihole\.home\.arpa/?$
      - traefik.http.middlewares.pihole-redirect.redirectregex.replacement=https://pihole.home.arpa/admin/
      - traefik.http.middlewares.pihole-redirect.redirectregex.permanent=true


  traefik:
    image: traefik:v2.11
    container_name: traefik
    depends_on:
      stepca-export:
        condition: service_completed_successfully
    networks:
      - proxy_net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/usersfile:/etc/traefik/usersfile:ro
      - ./artifacts/pki:/certs/:ro
      - traefik-data:/data
    restart: unless-stopped
    environment:
      - SSL_CERT_FILE=/certs/root_ca.crt
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy_net
      # Router fÃ¼rs Traefik Dashboard
      - traefik.http.routers.traefik.rule=Host(`traefik.home.arpa`)
      - traefik.http.routers.traefik.entrypoints=websecure
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.tls=true
      - traefik.http.routers.traefik.tls.certresolver=stepca

      # BasicAuth Middleware -> admin
      - traefik.http.middlewares.traefik-auth.basicauth.usersfile=/etc/traefik/usersfile
      # Middleware am Router aktivieren
      - traefik.http.routers.traefik.middlewares=traefik-auth

  stepca:
    image: smallstep/step-ca:0.26.1
    container_name: stepca
    networks:
      - proxy_net
    volumes:
      - stepca-data:/home/step
      - ./config/stepca/password.txt:/run/password.txt:ro
    environment:
      DOCKER_STEPCA_INIT_NAME: ${STEPCA_INIT_NAME:-home-arpa-ca}
      DOCKER_STEPCA_INIT_DNS_NAMES: ${STEPCA_INIT_DNS_NAMES:-stepca,stepca.home.arpa}
      DOCKER_STEPCA_INIT_ADDRESS: ${STEPCA_INIT_ADDRESS:-:9000}
      DOCKER_STEPCA_INIT_PROVISIONER_NAME: ${STEPCA_INIT_PROVISIONER_NAME:-admin}
      DOCKER_STEPCA_INIT_PASSWORD_FILE: /run/password.txt
      DOCKER_STEPCA_INIT_ACME: ${STEPCA_INIT_ACME:-true}
    restart: unless-stopped
    extra_hosts:
      - "traefik.home.arpa:host-gateway"
      - "pihole.home.arpa:host-gateway"

  stepca-export:
    image: curlimages/curl:8.6.0
    depends_on:
      - stepca
    networks:
      - proxy_net
    volumes:
      - ./artifacts/pki:/export
      - ./config/stepca/export-roots.sh:/usr/local/bin/export-roots.sh:ro
    entrypoint: ["/bin/sh", "-lc"]
    command: ["sh /usr/local/bin/export-roots.sh"]
    restart: "no"

networks:
  dns_net:
    name: dns_net
    driver: bridge

  proxy_net:
    name: proxy_net
    driver: bridge

volumes:
  pihole-etc:
  pihole-dnsmasq:
  unbound:
  stepca-data:
  traefik-data:
